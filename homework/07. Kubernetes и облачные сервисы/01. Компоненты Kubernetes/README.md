# Домашнее задание по теме: «Компоненты Kubernetes»

## Цель задания

Рассчитать требования к кластеру под проект.

## Задание 1. Создать Deployment приложения, состоящего из двух контейнеров и обменивающихся данными.

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения.
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии.
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий.
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.

## Ответ

*Исходим из того, что наша инфраструктура развернута в облаке (Yandex Cloud), это влияет на параметры создаваемых ВМ*

Поскольку некоторым БД и кэшу требуется отказоустойчивость рассчитываем минимум две ноды.

**Посчитаем общее количество ресурсов для чарта:**

1. **База данных:**
    * Ресурсы на один экземпляр: 4 ГБ ОЗУ, 1 ядро
    * Количество реплик: 3 + 1 (для роллинг апдейта)
    * Всего ресурсов: 4 ГБ ОЗУ * 4 = 16 ГБ ОЗУ, 1 ядро * 4 = 4 ядра
2. **Система кеширования:**
    * Ресурсы на один экземпляр: 4 ГБ ОЗУ, 1 ядро
    * Количество реплик: 3 + 1 (для роллинг апдейта)
    * Всего ресурсов: 4 ГБ ОЗУ * 4 = 16 ГБ ОЗУ, 1 ядро * 4 = 4 ядра
3. **Фронтенд:**
    * Ресурсы на один экземпляр: не более 50 МБ ОЗУ, 0.2 ядра
    * Количество реплик: 5 + 1 (для роллинг апдейта)
    * Всего ресурсов: (50 МБ * 6) = 300 МБ ОЗУ, (0.2 ядра * 6) = 1.2 ядра
4. **Бекенд:**
    * Ресурсы на один экземпляр: 600 МБ ОЗУ, 1 ядро
    * Количество копий: 10 + 1
    * Всего ресурсов: (600 МБ * 11) = 6600 МБ ОЗУ, (1 ядро * 11) = 11 ядер

**Итого:**
  * Память: 16 + 16 + 0.3 + 6.6 = 38.9 ГБ
  * CPU: 4 + 4 + 1.2 + 11 = 20.2 CPU

Нужно учитывать, что минимум одна нода может выйти из строя. Оптимальным вариантом будет 4 ВМ с 8 CPU / 16 ГБ (общая 32 CPU / 64 ГБ), это обеспечит функционирование системы при выводе из строя одной ноды (3 ноды = 24 CPU / 48 ГБ покрывают нагрузку).

**Посчитаем количество ресурсов для OS + Kubelet + Eviction Threshold:**

**Исходя из документации по CPU:**
  * 6% от первого ядра
  * 1% от следующего ядра (до 2 ядер)
  * 0.5% от следующих двух ядер (до 4)
  * 0.25% любых ядер выше четырех

**Ресурсы по памяти:**
  * 255 Мб памяти для компьютеров с объемом памяти менее 1 ГБ
  * 25% от первых 4 ГБ памяти
  * 20 % от следующих 4 ГБ памяти (до 8 ГБ)
  * 10 % от следующих 8 ГБ памяти (до 16 ГБ)
  * 6% от следующих 112 ГБ памяти (до 128 ГБ)

**Считаем требования к одной ноде:**
  * 0.6 + 0.1 + 0.1 + 0.1 = 1 CPU (4 CPU для четырех нод)
  * 1 + 0.8 + 0.8 + 0.1 (порог вытеснения) = 2.7 ГБ (10,8 ГБ для четырех нод)

---

**Итого:** требуемые ресурсы для кластера = 24.2 CPU, 44.08 ГБ (4 ВМ с 8 CPU / 16 ГБ учитывая выход из строя одной ноды и последующее распределение реплик). Расчет актуален для воркер нод, мастер отдельно.
